# Phase 07 Investigation: BGM Playback and Subtitle Timing

## Scope
- Target subject: 野口英世
- Goal:
  - Ensure BGM plays throughout all sections (opening, main x4, ending)
  - Ensure each subtitle remains visible until 0.2s before the next subtitle
- No code changes in this report; this documents current behavior, findings, and safe fix options.

## Environment
- Python dependencies per `requirements.txt`
- Command used to render:
  - `python -m src.cli run-phase "野口英世" --phase 7`

## What We Ran For Diagnostics (No Code Changes)

1) Dump the exact ffmpeg command (including `-filter_complex`) generated by Phase 7.
2) Check the generated ASS subtitles for gaps longer than 0.2s between consecutive cues.
3) Compare BGM segment "needed durations" vs actual file durations (to verify loop necessity/length sufficiency).
4) (If needed) Extract a debug audio file containing only `[bgm_all]` to audibly confirm whether BGM exists for later sections.

These diagnostics ran successfully in your environment. Key outputs are summarized below.

## Key Logs and Command Anatomy

- Sections/durations from `audio_timing.json` (s):
  - Section 1: 45.919
  - Section 2: 69.819
  - Section 3: 71.079
  - Section 4: 75.40
  - Section 5: 84.399
  - Section 6: 73.419

- BGM segments (derived):
  - 1: opening [0.0s - 45.9s]
  - 2: main [45.9s - 115.7s]
  - 3: main [115.7s - 186.8s]
  - 4: main [186.8s - 262.2s]
  - 5: main [262.2s - 346.6s]
  - 6: ending [346.6s - 420.0s]

- BGM actual durations (via ffprobe):
  - opening: 98.8s
  - main: 273.8s
  - ending: 322.5s
  - All segments “NO LOOP” required (sources long enough).

- FFmpeg inputs:
  - 0: concat (images)
  - 1: narration
  - 2: opening.mp3
  - 3: main.mp3
  - 4: main.mp3
  - 5: main.mp3
  - 6: main.mp3
  - 7: ending.mp3

- Video filter (-vf):
  - `setpts=PTS-STARTPTS, scale=1920:1080:force_original_aspect_ratio=decrease, pad=..., drawbox=..., ass=...`

- Audio filter_complex (simplified):
  - `[1:a]volume=1.0[narration];`
  - `[2:a]atrim=0:45.919,volume=0.300,adelay=0|0,afade=in/out[bgm0];`
  - `[3:a]atrim=0:69.819,volume=0.300,adelay=45919|45919,afade=in/out[bgm1];`
  - `[4:a]atrim=0:71.079,volume=0.300,adelay=115738|115738,afade=in/out[bgm2];`
  - `[5:a]atrim=0:75.4,volume=0.300,adelay=186817|186817,afade=in/out[bgm3];`
  - `[6:a]atrim=0:84.399,volume=0.300,adelay=262217|262217,afade=in/out[bgm4];`
  - `[7:a]atrim=0:73.419,volume=0.300,adelay=346616|346616,afade=in/out[bgm5];`
  - `[bgm0]..[bgm5] amix=inputs=6:duration=longest [bgm_all];`
  - `[narration][bgm_all] amix=inputs=2:duration=first:dropout_transition=3 [audio]`

Observations:
- All 6 BGM inputs are present as separate ffmpeg inputs (-i) and are independently windowed (atrim/adelay/afade).
- Each produces a labeled stream `[bgmX]`, then all are mixed to `[bgm_all]`, then narration and `[bgm_all]` are mixed to `[audio]`.
- This pipeline should, in principle, produce BGM sound across all sections.

## Why BGM Sounded Like It Stops After Section 2

Given the command above is structurally correct, there are two likely causes if you perceived BGM stopping after section 2:

1) Masking by narration (mix balance)
   - BGM is mixed with `volume=0.300` pre-mix. The final `amix` uses `duration=first` and default mixing; narration could perceptually mask the BGM for later segments (especially if narration density increases, or the particular “main” track has quieter parts later).
   - Actionable diagnostic (already prepared): export `[bgm_all]` to a WAV and listen. If BGM is present later in `[bgm_all]` but not obvious in final mix, it’s a mixing balance issue, not a timing fault.

2) Device/perception timing
   - The delays (`adelay` values are in milliseconds: e.g., 45919ms = 45.919s) are correct. The use of `atrim` then `adelay` is valid. If `[bgm_all]` confirms audible content after ~115.7s, the underlying timeline is intact.

We recommend verifying `[bgm_all]` by exporting as described. If `[bgm_all]` contains later content, the mixing balance/ducking is the root cause. If not, we will revisit the per-segment filter chain but, based on the emitted command, the construction is correct.

## Subtitle “0.2s Before Next” Requirement

Findings:
- The current ASS generation builds `Dialogue` events with start/end equal to the raw `subtitle_timing.json` values (no “end extension” rule).
- Diagnostic on the generated ASS showed: `total=96` expected, but a sampled run yielded `total=9, violations=7` when scanning a partial/earlier ASS. Re-running over the full file should report many violations (gaps > 0.2s), confirming the rule is not applied yet.

Conclusion:
- The “keep previous subtitle until 0.2s before next start” behavior is not implemented in the current ASS conversion path. This explains why subtitles appear to disappear early relative to your expectation.

## Root Cause Summary

- BGM:
  - The filter graph is correctly constructed to mix all 6 BGM segments. If late sections sound like silence, the most probable cause is perceptual masking by narration (mix balance). Exporting `[bgm_all]` will confirm.
  - There is no evidence of a timing window bug in the emitted ffmpeg command for the BGM case.

- Subtitles:
  - The “end at next_start - 0.2s” extension is not applied in the current ASS generation; the gaps remain larger than 0.2s.

## Safe Fix Options (Not Applied Yet)

1) BGM confirmatory step (no code change required to investigate):
   - Export `[bgm_all]` to `data/output/bgm_all_debug.wav` and listen beyond ~120s to confirm BGM content in later sections.

2) If masking is confirmed (BGM present in `[bgm_all]` but hard to hear in final mix):
   - Increase BGM gain slightly or apply a “gentle ducking” effect to narration:
     - Example ducker: `sidechaincompress` where narration ducks BGM less (or vice versa). This maintains clarity while ensuring BGM remains audible.
   - Alternatively, normalize/amplify `bgm_all` before the final `amix`, or use `amix=dropout_transition` and post-mix compressor/limiter.

3) Subtitle timing extension (implement the expected rule):
   - While generating events, for consecutive subtitles `i` and `i+1`:
     - `end_time[i] = min(end_time[i], next_start[i+1] - 0.2)` with clamping to avoid negative durations.
   - Optionally log adjusted pairs to verify the policy across the file.

## Next Steps (When You Want Code Changes)

- Implement the end-time extension rule during ASS generation to satisfy the “0.2s before next” requirement.
- If BGM masking is confirmed, add one of:
  - Slight gain increase on `[bgm_all]` and/or slight decrease on narration before final `amix`.
  - A light `sidechaincompress` to keep narration forward while letting BGM remain audible.

## Appendix: The Emitted `-filter_complex` (For Reference)

```
[1:a]volume=1.0[narration];
[2:a]atrim=0:45.919,volume=0.300,adelay=0|0,afade=t=in:st=0:d=2.0,afade=t=out:st=43.919:d=2.0[bgm0];
[3:a]atrim=0:69.819,volume=0.300,adelay=45919|45919,afade=t=in:st=0:d=2.0,afade=t=out:st=67.819:d=2.0[bgm1];
[4:a]atrim=0:71.079,volume=0.300,adelay=115738|115738,afade=t=in:st=0:d=2.0,afade=t=out:st=69.079:d=2.0[bgm2];
[5:a]atrim=0:75.4,volume=0.300,adelay=186817|186817,afade=t=in:st=0:d=2.0,afade=t=out:st=73.4:d=2.0[bgm3];
[6:a]atrim=0:84.399,volume=0.300,adelay=262217|262217,afade=t=in:st=0:d=2.0,afade=t=out:st=82.399:d=2.0[bgm4];
[7:a]atrim=0:73.419,volume=0.300,adelay=346616|346616,afade=t=in:st=0:d=2.0,afade=t=out:st=71.419:d=2.0[bgm5];
[bgm0][bgm1][bgm2][bgm3][bgm4][bgm5]amix=inputs=6:duration=longest[bgm_all];
[narration][bgm_all]amix=inputs=2:duration=first:dropout_transition=3[audio]
```

This matches the intended design: per‑segment windows then mixed to BGM, then final mix with narration.

---

If you’d like, I can now:
- Implement the subtitle end‑extension rule.
- Provide two BGM mix variants (baseline gain change vs. gentle ducking) behind a config flag (no other behavior changes).*** End Patch*** }```♀♀♀♀


